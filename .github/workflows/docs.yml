name: Documentation

on:
  push:
    branches: [main, master]
    paths:
      - "pyiv/**"
      - ".github/workflows/docs.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "pyiv/**"
      - ".github/workflows/docs.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.12-docs-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-3.12-docs-
            ${{ runner.os }}-pip-3.12-

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build hatchling

      - name: Install project and documentation dependencies
        run: |
          pip install -e ".[dev]"
          pip install pydoc-markdown sphinx sphinx-rtd-theme || pip install pydoc-markdown

      - name: Generate documentation with pydoc
        run: |
          mkdir -p docs/html
          # Generate HTML documentation for all modules in pyiv package
          find pyiv -name "*.py" -type f | while read -r file; do
            # Convert file path to module path
            module_path=$(echo "$file" | sed 's|^\./||' | sed 's|/|.|g' | sed 's|\.py$||')
            echo "Generating docs for: $module_path"
            python -m pydoc -w "$module_path" || true
          done
          # Move generated HTML files to docs/html
          mv *.html docs/html/ 2>/dev/null || true

      - name: Generate documentation with pydoc-markdown (if available)
        run: |
          if command -v pydoc-markdown &> /dev/null; then
            mkdir -p docs/markdown
            pydoc-markdown -p pyiv -o docs/markdown/ || true
          else
            echo "pydoc-markdown not available, skipping markdown generation"
          fi

      - name: Create index.html
        run: |
          cat > docs/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>PyIV Documentation</title>
              <meta charset="utf-8">
              <style>
                  body { 
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      margin: 0;
                      padding: 20px;
                      background-color: #f5f5f5;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      padding: 40px;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  h1 { 
                      color: #333;
                      border-bottom: 3px solid #0066cc;
                      padding-bottom: 10px;
                  }
                  h2 {
                      color: #555;
                      margin-top: 30px;
                  }
                  .description {
                      color: #666;
                      font-size: 1.1em;
                      margin: 20px 0;
                  }
                  ul { 
                      list-style-type: none; 
                      padding: 0; 
                  }
                  li { 
                      margin: 10px 0;
                      padding: 8px;
                      background: #f9f9f9;
                      border-left: 3px solid #0066cc;
                  }
                  a { 
                      color: #0066cc; 
                      text-decoration: none; 
                      font-weight: 500;
                  }
                  a:hover { 
                      text-decoration: underline; 
                  }
                  .module-name {
                      font-family: 'Monaco', 'Courier New', monospace;
                      color: #333;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>PyIV Documentation</h1>
                  <p class="description">Generated API documentation for PyIV - A lightweight dependency injection library for Python.</p>
                  <h2>Modules</h2>
                  <ul>
          EOF
          # Add links to all generated HTML files
          find docs/html -name "*.html" -type f ! -name "index.html" | sort | while read -r file; do
              filename=$(basename "$file")
              modulename=$(echo "$filename" | sed 's|\.html$||')
              echo "                      <li><a href=\"$filename\"><span class=\"module-name\">$modulename</span></a></li>" >> docs/html/index.html
          done
          echo "                  </ul>" >> docs/html/index.html
          echo "                  <hr>" >> docs/html/index.html
          echo "                  <p style=\"color: #999; font-size: 0.9em; margin-top: 30px;\">" >> docs/html/index.html
          echo "                      Generated on $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> docs/html/index.html
          echo "                  </p>" >> docs/html/index.html
          echo "              </div>" >> docs/html/index.html
          echo "          </body>" >> docs/html/index.html
          echo "          </html>" >> docs/html/index.html

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: pyiv-documentation
          path: docs/
          if-no-files-found: warn

      - name: Setup Pages
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/html

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        id: deployment
        uses: actions/deploy-pages@v4

