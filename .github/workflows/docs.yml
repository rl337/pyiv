name: Documentation

on:
  push:
    branches: [main, master]
    paths:
      - "pyiv/**"
      - ".github/workflows/docs.yml"
  pull_request:
    branches: [main, master]
    paths:
      - "pyiv/**"
      - ".github/workflows/docs.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.12-docs-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-3.12-docs-
            ${{ runner.os }}-pip-3.12-

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build hatchling

      - name: Install project and documentation dependencies
        run: |
          pip install -e ".[dev]"
          pip install pydoc-markdown sphinx sphinx-rtd-theme || pip install pydoc-markdown

      - name: Generate documentation with pydoc
        run: |
          mkdir -p docs/html
          # Generate HTML documentation for all modules in pyiv package
          find pyiv -name "*.py" -type f | while read -r file; do
            # Convert file path to module path
            module_path=$(echo "$file" | sed 's|^\./||' | sed 's|/|.|g' | sed 's|\.py$||')
            echo "Generating docs for: $module_path"
            python -m pydoc -w "$module_path" || true
          done
          # Move generated HTML files to docs/html
          mv *.html docs/html/ 2>/dev/null || true

      - name: Generate documentation with pydoc-markdown (if available)
        run: |
          if command -v pydoc-markdown &> /dev/null; then
            mkdir -p docs/markdown
            pydoc-markdown -p pyiv -o docs/markdown/ || true
          else
            echo "pydoc-markdown not available, skipping markdown generation"
          fi

      - name: Create index.html
        run: |
          cat > docs/html/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>PyIV Documentation - Python Dependency Injection Library</title>
              <meta charset="utf-8">
              <meta name="description" content="PyIV - A lightweight, type-aware dependency injection library for Python applications">
              <style>
                  body { 
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                      margin: 0;
                      padding: 20px;
                      background-color: #f5f5f5;
                      line-height: 1.6;
                  }
                  .container {
                      max-width: 1200px;
                      margin: 0 auto;
                      background: white;
                      padding: 40px;
                      border-radius: 8px;
                      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                  }
                  h1 { 
                      color: #333;
                      border-bottom: 3px solid #0066cc;
                      padding-bottom: 10px;
                      margin-top: 0;
                  }
                  h2 {
                      color: #555;
                      margin-top: 40px;
                      border-bottom: 2px solid #e0e0e0;
                      padding-bottom: 8px;
                  }
                  h3 {
                      color: #666;
                      margin-top: 30px;
                  }
                  .description {
                      color: #666;
                      font-size: 1.2em;
                      margin: 20px 0;
                      font-weight: 300;
                  }
                  .features {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 20px;
                      margin: 30px 0;
                  }
                  .feature {
                      padding: 20px;
                      background: #f9f9f9;
                      border-radius: 6px;
                      border-left: 4px solid #0066cc;
                  }
                  .feature h4 {
                      margin-top: 0;
                      color: #0066cc;
                  }
                  .code-block {
                      background: #f5f5f5;
                      border: 1px solid #ddd;
                      border-radius: 4px;
                      padding: 15px;
                      margin: 15px 0;
                      overflow-x: auto;
                      font-family: 'Monaco', 'Courier New', monospace;
                      font-size: 0.9em;
                  }
                  .code-block code {
                      color: #333;
                  }
                  .modules-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                      gap: 15px;
                      margin: 30px 0;
                  }
                  .module-card {
                      padding: 15px;
                      background: #f9f9f9;
                      border-radius: 6px;
                      border: 1px solid #e0e0e0;
                      transition: all 0.2s;
                  }
                  .module-card:hover {
                      border-color: #0066cc;
                      box-shadow: 0 2px 8px rgba(0,102,204,0.1);
                      transform: translateY(-2px);
                  }
                  .module-card a {
                      color: #0066cc;
                      text-decoration: none;
                      font-weight: 500;
                      display: block;
                  }
                  .module-card a:hover {
                      text-decoration: underline;
                  }
                  .module-name {
                      font-family: 'Monaco', 'Courier New', monospace;
                      color: #333;
                      font-size: 0.95em;
                  }
                  .module-desc {
                      color: #666;
                      font-size: 0.85em;
                      margin-top: 5px;
                  }
                  .badge {
                      display: inline-block;
                      padding: 4px 8px;
                      background: #0066cc;
                      color: white;
                      border-radius: 4px;
                      font-size: 0.85em;
                      font-weight: 500;
                      margin-right: 10px;
                  }
                  .quick-links {
                      margin: 30px 0;
                      padding: 20px;
                      background: #e8f4f8;
                      border-radius: 6px;
                      border-left: 4px solid #0066cc;
                  }
                  .quick-links a {
                      color: #0066cc;
                      text-decoration: none;
                      font-weight: 500;
                      margin-right: 20px;
                  }
                  .quick-links a:hover {
                      text-decoration: underline;
                  }
                  hr {
                      border: none;
                      border-top: 1px solid #e0e0e0;
                      margin: 40px 0;
                  }
                  .footer {
                      color: #999;
                      font-size: 0.9em;
                      margin-top: 40px;
                      padding-top: 20px;
                      border-top: 1px solid #e0e0e0;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>PyIV Documentation</h1>
                  <p class="description">
                      <span class="badge">v0.2.4</span>
                      A lightweight, type-aware dependency injection library for Python applications.
                      PyIV provides a simple yet powerful way to manage dependencies, improve testability, and reduce coupling.
                  </p>

                  <div class="quick-links">
                      <strong>Quick Links:</strong>
                      <a href="https://github.com/rl337/pyiv">GitHub Repository</a>
                      <a href="https://github.com/rl337/pyiv/blob/main/README.md">README</a>
                      <a href="https://pypi.org/project/pyiv/">PyPI Package</a>
                  </div>

                  <h2>Key Features</h2>
                  <div class="features">
                      <div class="feature">
                          <h4>üîß Type-Based Resolution</h4>
                          <p>Automatic dependency resolution using Python type annotations. No manual wiring required.</p>
                      </div>
                      <div class="feature">
                          <h4>üéØ Singleton Management</h4>
                          <p>Built-in singleton lifecycle management (per-injector or global) for efficient resource usage.</p>
                      </div>
                      <div class="feature">
                          <h4>üè≠ Factory Pattern</h4>
                          <p>Factory pattern support for complex object creation with dependency injection.</p>
                      </div>
                      <div class="feature">
                          <h4>üß™ Test-Friendly</h4>
                          <p>Built-in abstractions for Clock, Filesystem, and DateTimeService make testing easy.</p>
                      </div>
                      <div class="feature">
                          <h4>üì¶ Zero Dependencies</h4>
                          <p>Pure Python implementation with no external dependencies. Lightweight and fast.</p>
                      </div>
                      <div class="feature">
                          <h4>üîç Reflection Support</h4>
                          <p>Automatic discovery of interface implementations in packages using ReflectionConfig.</p>
                      </div>
                  </div>

                  <h2>Quick Start</h2>
                  <p>Get started with PyIV in just a few lines of code:</p>
                  <div class="code-block">
                      <code>
from pyiv import Config, get_injector<br><br>
# Define your configuration<br>
class MyConfig(Config):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def configure(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.register(Database, PostgreSQL)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.register(Logger, FileLogger, singleton=True)<br><br>
# Create injector and resolve dependencies<br>
injector = get_injector(MyConfig)<br>
db = injector.inject(Database)<br>
logger = injector.inject(Logger)
                      </code>
                  </div>

                  <h2>Core Modules</h2>
                  <p>Explore the PyIV modules to understand the full capabilities:</p>
                  <div class="modules-grid">
          EOF
          # Add module cards with descriptions
          python3 << 'PYTHON_EOF'
import os
import re

modules = {
    'pyiv': 'Main package - Core dependency injection framework',
    'pyiv.injector': 'Dependency injection engine - Creates and manages instances',
    'pyiv.config': 'Configuration base class - Register dependencies',
    'pyiv.singleton': 'Singleton lifecycle management - Per-injector or global',
    'pyiv.factory': 'Factory pattern support - Create objects with dependencies',
    'pyiv.clock': 'Time abstraction - RealClock for production, SyntheticClock for testing',
    'pyiv.filesystem': 'File I/O abstraction - RealFilesystem for production, MemoryFilesystem for testing',
    'pyiv.datetime_service': 'DateTime abstraction - PythonDateTimeService for production, MockDateTimeService for testing',
    'pyiv.reflection': 'Reflection-based discovery - Automatically find implementations',
    'pyiv.command': 'Command interface - Build CLI applications with dependency injection'
}

# Find all HTML files
html_dir = 'docs/html'
if os.path.exists(html_dir):
    html_files = [f for f in os.listdir(html_dir) if f.endswith('.html') and f != 'index.html']
    for filename in sorted(html_files):
        modulename = filename.replace('.html', '')
        # Clean up module name (remove pyiv. prefix for display)
        display_name = modulename.replace('pyiv.', '')
        if display_name == 'pyiv':
            display_name = '__init__'
        
        desc = modules.get(modulename, 'Module documentation')
        
        print(f'                      <div class="module-card">')
        print(f'                          <a href="{filename}">')
        print(f'                              <div class="module-name">{modulename}</div>')
        print(f'                              <div class="module-desc">{desc}</div>')
        print(f'                          </a>')
        print(f'                      </div>')
PYTHON_EOF
          cat >> docs/html/index.html << 'EOF'
                  </div>

                  <h2>Example: Testing with Abstractions</h2>
                  <p>PyIV makes testing easy with built-in abstractions:</p>
                  <div class="code-block">
                      <code>
from pyiv.clock import Clock, SyntheticClock<br>
from pyiv.filesystem import Filesystem, MemoryFilesystem<br>
from pyiv import Config, get_injector<br><br>
# Production config<br>
class ProdConfig(Config):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def configure(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.register(Clock, RealClock)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.register(Filesystem, RealFilesystem)<br><br>
# Test config<br>
class TestConfig(Config):<br>
&nbsp;&nbsp;&nbsp;&nbsp;def configure(self):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.register(Clock, SyntheticClock, singleton=True)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.register(Filesystem, MemoryFilesystem)<br><br>
# Use in tests<br>
injector = get_injector(TestConfig)<br>
clock = injector.inject(Clock)<br>
clock.set_time(100.0)  # Control time in tests!<br>
filesystem = injector.inject(Filesystem)<br>
filesystem.write_text('test.txt', 'content')  # In-memory filesystem!
                      </code>
                  </div>

                  <h2>Installation</h2>
                  <div class="code-block">
                      <code>
pip install pyiv<br><br>
# Or with Poetry<br>
poetry add pyiv
                      </code>
                  </div>

                  <hr>

                  <h2>API Documentation</h2>
                  <p>Browse the complete API documentation for each module:</p>
                  <ul style="list-style-type: none; padding: 0;">
          EOF
          # Add links to all generated HTML files
          find docs/html -name "*.html" -type f ! -name "index.html" | sort | while read -r file; do
              filename=$(basename "$file")
              modulename=$(echo "$filename" | sed 's|\.html$||')
              echo "                      <li style=\"margin: 10px 0; padding: 8px; background: #f9f9f9; border-left: 3px solid #0066cc;\"><a href=\"$filename\"><span class=\"module-name\">$modulename</span></a></li>" >> docs/html/index.html
          done
          cat >> docs/html/index.html << 'EOF'
                  </ul>

                  <div class="footer">
                      <p>
                          Generated on $(date -u +"%Y-%m-%d %H:%M:%S UTC") | 
                          <a href="https://github.com/rl337/pyiv" style="color: #0066cc;">View on GitHub</a> | 
                          <a href="https://pypi.org/project/pyiv/" style="color: #0066cc;">View on PyPI</a>
                      </p>
                  </div>
              </div>
          </body>
          </html>
          EOF

      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: pyiv-documentation
          path: docs/
          if-no-files-found: warn

      - name: Setup Pages
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/html

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        id: deployment
        uses: actions/deploy-pages@v4

